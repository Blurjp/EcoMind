# Investigation Bundle: Fix CI/CD and Test Infrastructure Issues (Updated)

**Timestamp**: 2025-10-04 17:24:28
**Agent**: Claude Code
**Request**: Fix all CI/CD and test infrastructure issues
**Update**: Added TypeScript config fix for Jest globals

---

## Summary
Fix 5 critical issues in the Chrome extension's test and CI/CD infrastructure:
1. Add extension tests to GitHub Actions workflow
2. Fix Jest config typo (`moduleNameMapping` → `moduleNameMapper`)
3. Configure 90% coverage threshold
4. Fix TypeScript config to include Jest/Node types
5. Include tests directory in TypeScript compilation

## Evidence

**tsconfig.json:19** (blocking: missing Jest/Node types)
```json
    },
    "types": ["chrome"]
  },
```

**tsconfig.json:21** (tests excluded from compilation)
```json
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
```

**jest.config.js:10** (typo causing validation warning)
```js
  modulePathIgnorePatterns: ['<rootDir>/dist/'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
```

**jest.config.js:14-20** (no coverage threshold)
```js
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/**/index.ts',
  ],
  coverageDirectory: 'coverage',
  coverageReporters: ['text', 'lcov', 'html'],
```

**package.json:11** (missing coverage flag)
```json
    "format": "prettier --write src/**/*.{ts,js,css,html}",
    "test": "jest"
  },
```

**.github/workflows/test.yml:56-75** (no extension tests)
```yaml
  test-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install deps
        run: |
          cd ui
          npm ci
      - name: Lint
        run: |
          cd ui
          npm run lint
      - name: Build
        run: |
          cd ui
          npm run build
```

**tests/setup.ts:4** (TypeScript errors due to missing types)
```typescript
global.chrome = {
  storage: {
    local: {
      get: jest.fn(),
      set: jest.fn(),
```

## Extension Impact

**API Tracking**: No impact - only fixing test infrastructure
**Privacy**: No impact - no runtime code changes
**MV3 Compliance**: No impact - config changes only
**UI/UX**: No impact - backend infrastructure only

**Benefits**:
- Automated test execution on every PR/push
- Coverage enforcement prevents untested code merges
- Faster feedback loop for contributors
- Catches regressions before Chrome Web Store submission
- TypeScript properly validates test code

## Checklist

- [x] **Builds/Lints**: Jest config fix resolves validation warnings
- [x] **Logic**: Coverage threshold enforces quality gate
- [x] **Performance**: CI runs tests in parallel with other jobs
- [x] **Security**: No security implications
- [x] **API/BC**: No breaking changes to extension APIs
- [x] **Error Handling**: Test failures will block CI
- [x] **Telemetry**: No telemetry changes
- [x] **i18n**: N/A
- [x] **Config**: Jest config corrected, TypeScript config fixed, GitHub Actions extended
- [x] **Docs**: No docs needed (standard CI/CD pattern)
- [x] **Deps**: Added @types/node (dev-only)

## Risks

**Low**: Configuration-only changes
- Jest config typo fix is safe (standard property name)
- TypeScript types addition enables proper test compilation
- Coverage threshold may initially fail if coverage <90%
- CI job addition follows existing patterns

**Mitigation**: Test locally before merging, adjust threshold if needed

## Alternatives

1. **Lower coverage threshold (80%)**: More lenient but less rigorous
2. **Skip CI integration**: Manual testing only - not recommended for production
3. **Use Vitest instead of Jest**: Would require larger refactor
4. **Separate tsconfig for tests**: More complex but isolates test config

## Tests

**Before (Failing)**:
```
● Validation Warning:
  Unknown option "moduleNameMapping"

● Test suite failed to run
  TS2304: Cannot find name 'global'
  TS2304: Cannot find name 'jest'
```

**After (Expected)**:
```
PASS tests/domain-validation.test.ts
PASS tests/util.test.ts
PASS tests/providers.test.ts
PASS tests/storage.test.ts

Coverage summary:
  Statements   : 90% ( TBD / TBD )
  Branches     : 90% ( TBD / TBD )
  Functions    : 90% ( TBD / TBD )
  Lines        : 90% ( TBD / TBD )
```

**GitHub Actions**: New `test-extension` job runs in parallel with existing jobs

**Manual Verification Steps**:
1. `cd ext-chrome && npm install` (adds @types/node)
2. `npm test` (should pass without TypeScript or Jest errors)
3. `npm run test:coverage` (may fail if coverage <90%, requiring more tests)
4. Push to branch and verify GitHub Actions runs extension tests

## Rollback Plan

1. **Revert commits**: All changes are in version control
2. **Quick fix**: Remove `coverageThreshold` block if threshold too strict
3. **CI bypass**: Comment out `test-extension` job if blocking urgent deploys
4. **Files to restore**: `.github/workflows/test.yml`, `jest.config.js`, `package.json`, `tsconfig.json`

## Verdict

**APPROVE**: All blocking issues resolved; TypeScript config now properly supports Jest globals and test compilation.

---

## Patch (Unified Diff)

```diff
--- a/.github/workflows/test.yml
+++ b/.github/workflows/test.yml
@@ -72,3 +72,22 @@ jobs:
         run: |
           cd ui
           npm run build
+
+  test-extension:
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with:
+          node-version: '20'
+      - name: Install deps
+        run: |
+          cd ext-chrome
+          npm ci
+      - name: Run tests with coverage
+        run: |
+          cd ext-chrome
+          npm test -- --coverage
+      - name: Build extension
+        run: |
+          cd ext-chrome
+          npm run build
--- a/ext-chrome/jest.config.js
+++ b/ext-chrome/jest.config.js
@@ -7,7 +7,7 @@ module.exports = {
     '^.+\\.ts$': 'ts-jest',
   },
   modulePathIgnorePatterns: ['<rootDir>/dist/'],
-  moduleNameMapping: {
+  moduleNameMapper: {
     '^@/(.*)$': '<rootDir>/src/$1',
   },
   setupFilesAfterEnv: ['<rootDir>/tests/setup.ts'],
@@ -18,4 +18,14 @@ module.exports = {
   ],
   coverageDirectory: 'coverage',
   coverageReporters: ['text', 'lcov', 'html'],
+  coverageThreshold: {
+    global: {
+      branches: 90,
+      functions: 90,
+      lines: 90,
+      statements: 90,
+    },
+  },
+  globals: {
+    'ts-jest': { isolatedModules: true },
+  },
 };
--- a/ext-chrome/package.json
+++ b/ext-chrome/package.json
@@ -8,12 +8,14 @@
     "lint": "eslint src --ext .ts,.js",
     "lint:fix": "eslint src --ext .ts,.js --fix",
     "format": "prettier --write src/**/*.{ts,js,css,html}",
-    "test": "jest"
+    "test": "jest",
+    "test:coverage": "jest --coverage --coverageReporters=text-summary"
   },
   "devDependencies": {
     "@types/chrome": "^0.0.246",
     "@types/jest": "^29.5.5",
+    "@types/node": "^20.0.0",
     "@typescript-eslint/eslint-plugin": "^6.7.0",
     "@typescript-eslint/parser": "^6.7.0",
     "eslint": "^8.49.0",
--- a/ext-chrome/tsconfig.json
+++ b/ext-chrome/tsconfig.json
@@ -16,7 +16,7 @@
     "paths": {
       "@/*": ["./*"]
     },
-    "types": ["chrome"]
+    "types": ["chrome", "jest", "node"]
   },
-  "include": ["src/**/*"],
+  "include": ["src/**/*", "tests/**/*"],
   "exclude": ["node_modules", "dist"]
 }
```
