# Code Review Bundle: Fix "Unknown" Model Display Issue

**Reviewer**: Claude Code
**Date**: 2025-10-09
**Task**: Investigate the problem that showing the top used model is unknown

---

## Summary

The "unknown" model issue occurs because **Chrome MV3 restricts access to request bodies** in the `webRequest.onBeforeRequest` API. The extension attempts to parse model names from JSON request bodies (lines 68-76 in `service-worker.ts`), but `details.requestBody` is almost always empty in MV3, causing all model extractors to return `'unknown'`.

The popup displays these unknown models on line 164 of `popup.ts` with a simple capitalization (`model === 'unknown' ? 'Unknown' : model`), providing no explanation to users about **why** models cannot be detected.

---

## Evidence

**src/bg/service-worker.ts:66-82** – MV3 body access limitation acknowledged but no fallback:
```typescript
// In MV3 without webRequestBlocking, request body is often empty
// We'll extract what we can from the URL and fall back to "unknown" for model
let requestBody: string | undefined;
if (details.requestBody?.raw?.[0]?.bytes) {
  try {
    const decoder = new TextDecoder();
    requestBody = decoder.decode(details.requestBody.raw[0].bytes);
  } catch {
    // Ignore decoding errors - common in MV3
  }
}

// Extract provider and model (model will often be "unknown" in MV3)
const { provider, model } = this.providerManager.extractModel(
  details.url,
  requestBody  // ← Almost always undefined in MV3
);
```

**src/bg/providers.ts:46-56** – All extractors depend on body parameter:
```typescript
extractModel(url: string, body?: string): { provider: string; model: string } {
  const provider = this.findProviderForUrl(url);
  if (!provider) {
    return { provider: 'unknown', model: 'unknown' };
  }

  const model = provider.modelExtractor
    ? provider.modelExtractor(url, body)  // ← body is undefined
    : 'unknown';

  return { provider: provider.name, model };
}
```

**src/common/constants.ts:21-30** – OpenAI extractor (representative example):
```typescript
modelExtractor: (url: string, body?: string) => {
  if (body) {  // ← Never true in MV3
    try {
      const parsed = JSON.parse(body);
      return parsed.model || 'unknown';
    } catch {
      // Ignore parsing errors
    }
  }
  return 'unknown';  // ← Always hits this line
},
```

**src/common/constants.ts:51-54** – Replicate has URL-based extraction:
```typescript
modelExtractor: (url: string) => {
  const match = url.match(/\/models\/([^\/]+\/[^\/]+)/);
  return match ? match[1] : 'unknown';
},
```

**src/ui/popup.ts:158-170** – Display shows "Unknown" without explanation:
```typescript
// Top models
if (Object.keys(data.models).length > 0) {
  const modelsSection = createSection('Top Models');
  const modelsData = Object.entries(data.models)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 5)
    .map(([model, count]) => ({
      label: model === 'unknown' ? 'Unknown' : model,  // ← No tooltip
      value: count.toString(),
    }));

  const modelsList = createList(modelsData);
  modelsSection.appendChild(modelsList);
  this.contentEl.appendChild(modelsSection);
}
```

---

## Extension Impact

**API Tracking**: ✅ No impact – tracking still works, provider names are detected
**Privacy**: ✅ No impact – displaying "Unknown" is privacy-preserving
**MV3 Compliance**: ✅ No impact – existing code is MV3-compliant
**UI/UX**: ❌ **Negative** – Users see "Unknown" without understanding **why** model detection fails

---

## Checklist

- [x] **Builds/Lints**: No code change proposed yet – documentation only
- [x] **Logic**: Root cause identified (MV3 body restriction)
- [x] **Perf**: N/A
- [x] **Security**: No security implications
- [x] **API/BC**: No API changes
- [x] **Error Handling**: Existing try/catch blocks adequate
- [x] **Logging**: Console warnings present (line 117)
- [x] **Telemetry**: Unknown models are sent to backend (lines 107-114)
- [x] **i18n**: English-only hardcoded text
- [ ] **Config**: Could add setting to toggle tooltip
- [x] **Docs**: MV3 limitation acknowledged in comments but not user-facing
- [x] **Deps**: No dependency changes

---

## Risks

**Low** – This is a **UX/documentation issue**, not a functional bug.

- ✅ Extension correctly tracks API calls and providers
- ✅ Environmental impact estimates still work (line 129-139 in popup.ts)
- ✅ Backend telemetry receives accurate provider data
- ⚠️ Users may think the extension is broken when seeing "Unknown" models

**Mitigation**: Add inline UI explanation (tooltip or note) about MV3 limitation.

---

## Alternatives

### Option 1: Add Tooltip to "Unknown" Models (Recommended)
**Pros**: Minimal code change, educates users, previous review approved similar approach
**Cons**: Requires modifying `createDataRow()` or `createList()` to support tooltips
**Complexity**: 10-15 lines

### Option 2: URL-Based Model Extraction for Web UIs
**Pros**: Reduces "unknown" count for ChatGPT/Claude web UI users
**Cons**: Only helps web UI users, not API users; requires maintaining URL patterns
**Complexity**: 20-30 lines (already designed in `codex_diffs/bundle_20251007_111226.md`)

### Option 3: Response Header Inspection (Future)
**Pros**: Could extract models from `x-model` or similar headers
**Cons**: Not all APIs return model in headers; requires `webRequest.onHeadersReceived` listener
**Complexity**: 40-50 lines

### Option 4: Do Nothing
**Pros**: Zero effort
**Cons**: Users remain confused

**Recommendation**: **Option 1** (tooltip) is the safest, quickest fix. **Option 2** can be added later for incremental improvement.

---

## Patch

**Minimal fix**: Add tooltip to "Unknown" models explaining MV3 limitation.

```diff
--- a/src/ui/components.ts
+++ b/src/ui/components.ts
@@ -26,12 +26,18 @@ export function createSection(title: string): HTMLElement {
   return section;
 }

-export function createDataRow(label: string, value: string): HTMLElement {
+export function createDataRow(
+  label: string,
+  value: string,
+  title?: string
+): HTMLElement {
   const row = createElement('div', 'data-row');
   const labelEl = createElement('span', 'data-label', label);
   const valueEl = createElement('span', 'data-value', value);
   row.appendChild(labelEl);
   row.appendChild(valueEl);
+  if (title) {
+    labelEl.title = title;
+  }
   return row;
 }

@@ -38,8 +44,8 @@ export function createDataRow(label: string, value: string): HTMLElement {
 }

 export function createList(
-  items: Array<{ label: string; value: string }>
+  items: Array<{ label: string; value: string; title?: string }>
 ): HTMLElement {
   const list = createElement('div', 'data-list');
   items.forEach((item) => {
-    list.appendChild(createDataRow(item.label, item.value));
+    list.appendChild(createDataRow(item.label, item.value, item.title));
   });
   return list;
 }
--- a/src/ui/popup.ts
+++ b/src/ui/popup.ts
@@ -161,7 +161,11 @@ class PopupManager {
       .sort(([, a], [, b]) => b - a)
       .slice(0, 5)
       .map(([model, count]) => ({
         label: model === 'unknown' ? 'Unknown' : model,
         value: count.toString(),
+        title:
+          model === 'unknown'
+            ? 'Chrome MV3 restricts request body access - provider detected but model name unavailable'
+            : undefined,
       }));

       const modelsList = createList(modelsData);
```

---

## Tests

### Before (Failing UX Test)
1. Load extension and visit ChatGPT
2. Open popup → See "Unknown" model
3. **User confused**: No explanation why model is unknown

### After (Passing UX Test)
1. Load extension and visit ChatGPT
2. Open popup → See "Unknown" model
3. Hover over "Unknown" → Tooltip: _"Chrome MV3 restricts request body access - provider detected but model name unavailable"_
4. **User educated**: Understands MV3 limitation

### Manual Testing
```bash
cd /Users/jianphua/projects/EcoMind
npm run build
# Load unpacked extension in Chrome
# Visit api.openai.com or chatgpt.com
# Open popup and hover over "Unknown"
```

---

## Rollback Plan

1. **Git revert** the commit applying this patch
2. **Or** replace `createDataRow()` signature back to 2 parameters
3. **Or** remove `title` property from `modelsData` mapping in popup.ts:166

**Risk**: Zero – tooltip is additive, no breaking changes

---

## Artifacts

**Patch**: `/Users/jianphua/projects/EcoMind/codex_diffs/diff_20251009_001035.patch`
**Review**: `/Users/jianphua/projects/EcoMind/codex_diffs/review_20251009_001035.md`
**Bundle**: `/Users/jianphua/projects/EcoMind/codex_diffs/bundle_20251009_001035.md`

**Latest pointers**:
- `/Users/jianphua/projects/EcoMind/codex_diffs/latest.patch`
- `/Users/jianphua/projects/EcoMind/codex_diffs/latest.review.md`
- `/Users/jianphua/projects/EcoMind/codex_diffs/latest.bundle.md`

---

## Verdict

**APPROVE** – The patch is a **safe, minimal UX improvement** that educates users about Chrome MV3 limitations without changing tracking logic, privacy model, or API surface. The 15-line diff adds a tooltip to "Unknown" models, resolving user confusion while preserving all existing functionality.

**Next steps**: User approval required before applying patch.
