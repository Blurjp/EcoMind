# Ecomind API Documentation

Base URL: `https://api.ecomind.example.com` (production) or `http://localhost:8000` (dev)

## Authentication

All requests require `Authorization: Bearer <token>` header (except `/health`).

For development, auth is optional.

---

## Endpoints

### Health

**GET /health**

Returns service health status.

```json
{
  "status": "healthy",
  "ts": "2025-09-30T12:00:00Z"
}
```

---

### Ingestion

**POST /v1/ingest**

Ingest an AI API call event.

**Request**:
```json
{
  "org_id": "org_123",
  "user_id": "user_abc",
  "provider": "openai",
  "model": "gpt-4o",
  "tokens_in": 100,
  "tokens_out": 50,
  "region": "US-CAISO",
  "ts": "2025-09-30T12:00:00Z"
}
```

**Response** `202 Accepted`:
```json
{
  "status": "accepted",
  "ts": "2025-09-30T12:00:00Z"
}
```

---

### Query

**GET /v1/today?org_id=X&user_id=Y**

Get today's aggregated usage.

**Response**:
```json
{
  "date": "2025-09-30",
  "org_id": "org_demo",
  "user_id": "user_alice",
  "call_count": 42,
  "kwh": 0.0189,
  "water_liters": 0.034,
  "co2_kg": 0.0076,
  "top_providers": [
    {"provider": "openai", "count": 30},
    {"provider": "anthropic", "count": 12}
  ],
  "top_models": [
    {"model": "gpt-4o", "count": 20},
    {"model": "claude-3-sonnet", "count": 12}
  ]
}
```

**GET /v1/aggregate/daily?org_id=X&from=YYYY-MM-DD&to=YYYY-MM-DD&group_by=provider**

Get daily aggregates with grouping.

`group_by`: `provider`, `model`, or `user`

---

### Organizations

**POST /v1/orgs**

Create an organization.

**GET /v1/orgs/{org_id}**

Get organization details.

**GET /v1/orgs**

List all organizations.

---

### Users

**POST /v1/users**

Create a user.

**GET /v1/users/{user_id}**

Get user details.

**GET /v1/orgs/{org_id}/users**

List users in an organization.

---

### Alerts

**POST /v1/alerts**

Create an alert.

```json
{
  "org_id": "org_123",
  "name": "High CO2 Usage",
  "metric": "co2_kg",
  "threshold": 10.0,
  "window": "1d",
  "channel": "slack",
  "webhook_url": "https://hooks.slack.com/..."
}
```

**GET /v1/orgs/{org_id}/alerts**

List alerts.

**DELETE /v1/alerts/{alert_id}**

Delete an alert.

---

### Reports

**POST /v1/reports**

Create an async report generation job.

```json
{
  "org_id": "org_123",
  "report_type": "esg",
  "format": "pdf",
  "from_date": "2025-01-01",
  "to_date": "2025-12-31"
}
```

**GET /v1/reports/{report_id}**

Get report status and download URL.

**GET /v1/orgs/{org_id}/reports**

List reports for an organization.

---

### Audits

**GET /v1/audits?org_id=X&limit=100**

List audit logs.

---

## OpenAPI Spec

Full OpenAPI 3.0 spec available at `/openapi.json` (auto-generated by FastAPI).

## Rate Limits

- Free tier: 10k events/day
- Pro tier: 1M events/day
- Enterprise: Custom

Rate limits enforced at gateway via Redis.

## Errors

Standard HTTP status codes:
- `400` Bad Request
- `401` Unauthorized
- `403` Forbidden
- `404` Not Found
- `429` Too Many Requests
- `500` Internal Server Error