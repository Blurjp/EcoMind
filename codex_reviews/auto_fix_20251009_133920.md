# Auto-Fix Report: Unknown Model Detection Analysis

**Date**: 2025-10-09 13:39:20
**Issue**: Top models still showing "unknown" as the top models
**Severity**: Medium
**Status**: NEEDS_MANUAL_REVIEW

---

## Summary

Investigated why "unknown" still appears as a top model after implementing URL-based fallback detection. The issue has multiple causes depending on which AI services are being tracked.

## Root Cause Analysis

### What Works ✅

The URL-based fallback implemented in commit `a4a7735` **does work correctly** for:

1. **ChatGPT Web UI** (chatgpt.com, chat.openai.com)
   - Detection: URL includes "chatgpt.com" → model = "chatgpt-web"
   - Location: `src/common/constants.ts:26-28`
   - Status: ✅ Working as designed

2. **Claude Web UI** (claude.ai)
   - Detection: URL includes "claude.ai" → model = "claude-web"
   - Location: `src/common/constants.ts:43-45`
   - Status: ✅ Working as designed

3. **Google AI** (generativelanguage.googleapis.com)
   - Detection: URL regex `/\/models\/([^\/\?]+)/` extracts model from path
   - Location: `src/common/constants.ts:125`
   - Status: ✅ Working (URL-based extraction)

4. **Replicate** (api.replicate.com)
   - Detection: URL regex `/\/models\/([^\\/]+\\/[^\\/]+)/` extracts owner/model
   - Location: `src/common/constants.ts:62`
   - Status: ✅ Working (URL-based extraction)

### What Doesn't Work ❌

The following scenarios will **always** show "unknown" due to Chrome MV3 limitations:

1. **OpenAI API Direct Calls** (api.openai.com/v1/chat/completions)
   - Problem: URL doesn't contain model name
   - Problem: Chrome MV3 webRequest API provides empty `requestBody`
   - Current behavior: Falls through to `return 'unknown'` at line 29
   - Impact: Any code/Postman/curl calls to OpenAI API show "unknown"

2. **Anthropic API Direct Calls** (api.anthropic.com/v1/messages)
   - Problem: URL doesn't contain model name
   - Problem: Chrome MV3 webRequest API provides empty `requestBody`
   - Current behavior: Falls through to `return 'unknown'` at line 46
   - Impact: Any code/Postman/curl calls to Anthropic API show "unknown"

3. **Other JSON-based APIs** (Together, Cohere, Perplexity)
   - Problem: Model name only in request body JSON (not in URL)
   - Problem: Chrome MV3 webRequest API provides empty `requestBody`
   - Current behavior: Falls through to `return 'unknown'`
   - Impact: All direct API calls show "unknown"

## Technical Explanation

### Chrome Manifest V3 Limitation

In Chrome MV3, the webRequest API has been severely restricted:

```typescript
// What we request (service-worker.ts:48):
chrome.webRequest.onBeforeRequest.addListener(
  handler,
  { urls: ['<all_urls>'], types: ['xmlhttprequest'] },
  ['requestBody']  // ← This is IGNORED by Chrome in MV3
);

// What we actually get:
details.requestBody = undefined  // Always empty in MV3
```

The `requestBody` parameter is **deprecated and non-functional in MV3**. Chrome does not provide:
- Request body (even when explicitly requested)
- Response body (never available in webRequest API)
- Request headers with Authorization (security restriction)

### Why URL Fallback is Partial

| Service Type | URL Contains Model? | Body Accessible? | Result |
|-------------|-------------------|-----------------|--------|
| ChatGPT Web UI | ❌ No | ❌ No | ✅ Fixed with URL domain check |
| Claude Web UI | ❌ No | ❌ No | ✅ Fixed with URL domain check |
| OpenAI API | ❌ No | ❌ No | ❌ Still shows "unknown" |
| Anthropic API | ❌ No | ❌ No | ❌ Still shows "unknown" |
| Google API | ✅ Yes (path) | ❌ No | ✅ Works with URL regex |
| Replicate API | ✅ Yes (path) | ❌ No | ✅ Works with URL regex |

## Files Analyzed

### src/common/constants.ts
**Lines 17-129**: Provider configuration with model extractors

**Current Implementation**:
```typescript
// OpenAI (lines 17-37)
{
  name: 'openai',
  domains: ['api.openai.com', 'chatgpt.com', 'chat.openai.com'],
  modelExtractor: (url: string, body?: string) => {
    // Try body parsing first (preserves accuracy when body available)
    if (body) {
      try {
        const parsed = JSON.parse(body);
        return parsed.model || 'unknown';
      } catch {
        // Ignore parsing errors
      }
    }
    // MV3 fallback: URL-based detection when body unavailable
    if (url.includes('chatgpt.com') || url.includes('chat.openai.com')) {
      return 'chatgpt-web';
    }
    return 'unknown';  // ← API calls end up here
  },
}
```

### src/bg/service-worker.ts
**Lines 61-118**: Web request handler that calls model extractors

**Key Section (lines 68-76)**:
```typescript
// In MV3 without webRequestBlocking, request body is often empty
// We'll extract what we can from the URL and fall back to "unknown" for model
let requestBody: string | undefined;
if (details.requestBody?.raw?.[0]?.bytes) {
  try {
    const decoder = new TextDecoder();
    requestBody = decoder.decode(details.requestBody.raw[0].bytes);
  } catch {
    // Ignore decoding errors - common in MV3
  }
}
```

**Reality**: The `if (details.requestBody?.raw?.[0]?.bytes)` condition is **never true** in Chrome MV3.

## Attempted Solutions

### ❌ Approach 1: Response Header Inspection
**Attempted**: Added `onCompleted` listener to inspect response headers
**Result**: Chrome MV3 doesn't provide response bodies either
**Reverted**: Yes (git checkout)

### ❌ Approach 2: Request/Response Correlation
**Attempted**: Map pending requests by `requestId` to extract from responses
**Result**: No response body available to extract from
**Reverted**: Yes (git checkout)

## Viable Solutions (Not Implemented)

### Option 1: Content Script with fetch() Interception ⭐ Recommended

Inject a content script on target domains that wraps `window.fetch()`:

```typescript
// content-script.ts
const originalFetch = window.fetch;
window.fetch = async function(...args) {
  const [url, init] = args;

  // Extract model from request body
  if (init?.body) {
    const body = JSON.parse(init.body);
    if (body.model) {
      chrome.runtime.sendMessage({
        type: 'API_CALL',
        url: url.toString(),
        model: body.model,
        provider: detectProvider(url),
      });
    }
  }

  return originalFetch.apply(this, args);
};
```

**Pros**:
- Full access to request/response bodies
- Works for all fetch()-based API calls
- Can extract token counts from responses

**Cons**:
- Requires `content_scripts` in manifest
- Must inject on `<all_urls>` (privacy/performance impact)
- Doesn't work for XMLHttpRequest (older code)
- Doesn't work for curl/Postman/external tools

### Option 2: Proxy/Middleware Approach

Require users to route API calls through a local proxy that logs model info:

```
User Code → localhost:8080 (proxy) → api.openai.com
                ↓
         Logs model to extension storage
```

**Pros**:
- Complete visibility into all API traffic
- Works for any client (curl, Postman, code)

**Cons**:
- Complex setup for users
- Requires running external proxy process
- Network configuration changes

### Option 3: Accept Limitation + Improve Tooltip

Keep current implementation but enhance the tooltip to explain:

```typescript
// In popup.ts, when rendering models with "unknown":
title: model === "unknown"
  ? "Chrome MV3 restricts request body access. Model detection works for:\n" +
    "✅ ChatGPT web (chatgpt.com) → shows 'chatgpt-web'\n" +
    "✅ Claude web (claude.ai) → shows 'claude-web'\n" +
    "❌ Direct API calls (api.openai.com, api.anthropic.com, etc) → shows 'unknown'\n\n" +
    "This is a Chrome security limitation, not a bug."
  : undefined
```

**Pros**:
- No code changes needed
- Transparent about limitations
- Users understand why "unknown" appears

**Cons**:
- Doesn't solve the problem
- Direct API users still see "unknown"

## Recommendations

### Immediate (Low Effort)
1. ✅ **Keep current URL fallback** - It works for web UIs
2. ✅ **Enhance tooltip** - Better explain why "unknown" appears for API calls
3. ✅ **Update documentation** - Add KNOWN_LIMITATIONS.md explaining MV3 restrictions

### Short Term (Medium Effort)
4. **Implement fetch() interception** (Option 1) - Solves most use cases
5. **Add XMLHttpRequest interception** - Covers older codebases
6. **Make content script opt-in** - Privacy-conscious users can disable

### Long Term (High Effort)
7. **Build browser extension for Firefox** - Manifest V2 still supported, full body access
8. **Create standalone proxy** - For users who need complete visibility
9. **Partner with API providers** - Request model info in response headers

## Verification

To verify current behavior, test with:

```bash
# Should show "chatgpt-web" (works ✅)
1. Visit chatgpt.com and send a message
2. Open popup → Top Models should show "chatgpt-web"

# Should show "claude-web" (works ✅)
1. Visit claude.ai and send a message
2. Open popup → Top Models should show "claude-web"

# Will show "unknown" (expected ❌)
1. Run: curl https://api.openai.com/v1/chat/completions \
       -H "Authorization: Bearer $OPENAI_API_KEY" \
       -H "Content-Type: application/json" \
       -d '{"model": "gpt-4", "messages": [{"role": "user", "content": "Hi"}]}'
2. Open popup → Top Models will show "unknown" for OpenAI provider
```

## Changes Made

None - investigation only. Attempted response header correlation was reverted.

## Artifacts

- **This report**: `codex_reviews/auto_fix_20251009_133920.md`
- **Conversation log**: `codex_reviews/conversation_20251009_130924.md` (previous fix)
- **Current code**: `src/common/constants.ts` (URL fallback working)
- **Service worker**: `src/bg/service-worker.ts` (webRequest handler, body always empty)

## Status: NEEDS_MANUAL_REVIEW

**Question for User**:

Which scenario are you experiencing "unknown" models in?

A) **Using ChatGPT web UI (chatgpt.com)** → This should be fixed, please clear extension data and reload
B) **Using Claude web UI (claude.ai)** → This should be fixed, please clear extension data and reload
C) **Making direct API calls via code/Postman** → Expected behavior due to MV3, needs fetch() interception (Option 1)
D) **Other scenario** → Please describe what service/method you're using

Please provide:
1. Which AI service(s) show "unknown"
2. How are you accessing them (web browser UI vs API calls)
3. Example URL of a request that shows "unknown"

This will help determine if this is a bug in the URL fallback or an expected MV3 limitation.

---

**Generated**: 2025-10-09 13:39:20
**Analyzed Files**:
- `src/common/constants.ts:17-129`
- `src/bg/service-worker.ts:39-118`
- `dist/constants.js:14-115` (verified build output)
